version: '3.8'
services:
  traefik:
    image: traefik:v2.10
    restart: unless-stopped
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - "--providers.docker=true"
      - "--api.insecure=true"
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    restart: always
    volumes:
      - kafka-data:/var/lib/kafka/data
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    restart: unless-stopped
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-log:/var/lib/zookeeper/log
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
  flink:
    image: flink:1.17.1-scala_2.12
    restart: always
    command: jobmanager
    ports:
      - "8081:8081"
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink
  flink-taskmanager:
    image: flink:1.17.1-scala_2.12
    restart: always
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink
        taskmanager.numberOfTaskSlots: 2
  cassandra:
    image: cassandra:4.0
    restart: always
    ports:
      - "9042:9042"
    volumes:
      - cassandra-data:/var/lib/cassandra
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe cluster' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  presto:
    image: prestodb/presto:latest
    restart: unless-stopped
    ports:
      - "8085:8080"
  grafana:
    image: grafana/grafana:9.5.0
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_INSTALL_PLUGINS=hadesarchitect-cassandra-datasource,simpod-json-datasource
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=hadesarchitect-cassandra-datasource
    depends_on:
      - cassandra
      - presto
  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
  airflow:
    image: apache/airflow:2.7.0
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
  postgres:
    image: postgres:13
    restart: unless-stopped
    environment:
      POSTGRES_DB: airflow
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
  producer:
    build: ./components/producer
    restart: unless-stopped
    ports:
      - "5000:5000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.yml:/docker-compose.yml:ro
    environment:
      COMPOSE_FILE: /docker-compose.yml
  producer-tests:
    build:
      context: ./components/producer
    command: ["pytest", "tests"]
    profiles:
      - tests
  acceptance-tests:
    build:
      context: ./components/producer
    command: ["pytest", "tests/test_acceptance.py", "-v", "-s"]
    depends_on:
      - producer
      - kafka
      - cassandra
    environment:
      PRODUCER_URL: http://producer:5000
    profiles:
      - acceptance
  flink-job:
    build: ./components/flink-job
    restart: always
    depends_on:
      cassandra:
        condition: service_healthy
      flink:
        condition: service_started
      kafka:
        condition: service_started
      minio:
        condition: service_started
    environment:
      CASSANDRA_TTL_SECONDS: ${CASSANDRA_TTL_SECONDS:-5184000}  # Default 60 days
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: event-logs

volumes:
  kafka-data:
  zookeeper-data:
  zookeeper-log:
  cassandra-data:
  minio-data:


